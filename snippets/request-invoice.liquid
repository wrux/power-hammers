{% comment %} {% if product.metafields.custom.disable_buy == true %}
  {{ 'request-invoice.css' | asset_url | stylesheet_tag }}

  {%- form 'contact',
      id: 'requestInvoice',
      return_to: "{{ product.url }}#requestInvoice",
      class: 'request-invoice-form'
  -%}
    <h3><strong>Request an invoice</strong></h3>

    <p>If you need to request an invoice for your accounting requirements, please use this form below.</p>

    <!-- Capture product name -->
    <input type="hidden" name="contact[product]" value="{{ product.title }}">

    <label for="your-email">Your email:</label>
    <input id="your-email"
           name="contact[email]"
           type="email"
           placeholder="Your email"
           required
           class="input input--text input--full">

    <button type="submit" class="product-form__submit button button--full-width button--secondary">
      Request an invoice
    </button>
  {%- endform -%}

  {% if form.posted_successfully? %}
    <p id="requestInvoiceMessage" class="request-invoice-success">
      ✅ Your invoice request has been sent. We’ll get back to you shortly.
    </p>
  {% elsif form.errors %}
    <p id="requestInvoiceMessage" class="request-invoice-error">
      ⚠️ There was an error submitting your request. Please try again.
    </p>
  {% endif %}
{% endif %} {% endcomment %}


<div id="hubspot-request-invoice-form" class="page-width">
  <div class="rte">
    <h2 class="title title--primary">Request an invoice</h2>
    <p>
      If you need to request an invoice for your accounting requirements, please
      use this form below.
    </p>
  </div>

  <form id="invoiceForm" class="contact__form">
    <input type="hidden" name="product" value="{{ product.title }}" />

    <div class="field">
      <label class="field__label" for="invoice-firstname">First Name</label>
      <input
        class="field__input"
        type="text"
        name="firstname"
        id="invoice-firstname"
        required
      />
    </div>

    <div class="field">
      <label class="field__label" for="invoice-lastname">Last Name</label>
      <input
        class="field__input"
        type="text"
        name="lastname"
        id="invoice-lastname"
        required
      />
    </div>

    <div class="field">
      <label class="field__label" for="invoice-email">Email</label>
      <input
        class="field__input"
        type="email"
        name="email"
        id="invoice-email"
        required
      />
    </div>

    <div class="field">
      <label class="field__label" for="invoice-phone">Phone Number</label>
      <input
        class="field__input"
        type="text"
        name="phone"
        id="invoice-phone"
        required
      />
    </div>

    <button type="submit" id="invoice-submit" class="button button--primary">
      <span class="button-text">Request an invoice</span>
      <svg
        id="loadingSpinner"
        class="loading-spinner hidden"
        xmlns="http://www.w3.org/2000/svg"
        fill="none"
        viewBox="0 0 24 24"
        width="20"
        height="20"
      >
        <circle
          class="opacity-25"
          cx="12"
          cy="12"
          r="10"
          stroke="currentColor"
          stroke-width="4"
        ></circle>
        <path
          class="opacity-75"
          fill="currentColor"
          d="M4 12a8 8 0 018-8v8z"
        ></path>
      </svg>
    </button>
  </form>

  <p id="formMessage" class="form__message"></p>
</div>

<script>
  document
    .getElementById("invoiceForm")
    .addEventListener("submit", async function (e) {
      e.preventDefault();

      const submitBtn = document.getElementById("invoice-submit");
      const spinner = document.getElementById("loadingSpinner");
      const buttonText = submitBtn.querySelector(".button-text");
      const formMessage = document.getElementById("formMessage");

      // Show loading state
      submitBtn.disabled = true;
      spinner.classList.remove("hidden");
      buttonText.style.display = "none";
      formMessage.textContent = "";
      formMessage.className = "form__message";

      // Gather form data in HubSpot expected format
      const formData = new FormData();
      formData.append(
        "product",
        document.querySelector('input[name="product"]').value
      );
      formData.append(
        "firstname",
        document.getElementById("invoice-firstname").value
      );
      formData.append(
        "lastname",
        document.getElementById("invoice-lastname").value
      );
      formData.append("email", document.getElementById("invoice-email").value);
      formData.append("phone", document.getElementById("invoice-phone").value);

      try {
        const response = await fetch(
          "https://forms.hubspot.com/uploads/form/v2/146360371/ecc249b0-b8df-46b2-8a84-0485f91c5eee",
          {
            method: "POST",
            body: formData,
          }
        );

        if (response.ok) {
          formMessage.textContent = "Thanks! Your request has been submitted.";
          formMessage.classList.add("form__message--success");
          document.getElementById("invoiceForm").reset();
        } else {
          throw new Error("Form submission failed");
        }
      } catch (error) {
        formMessage.textContent =
          "Oops! Something went wrong. Please try again.";
        formMessage.classList.add("form__message--error");
      } finally {
        // Reset loading state
        submitBtn.disabled = false;
        spinner.classList.add("hidden");
        buttonText.style.display = "inline";
      }
    });
</script>
